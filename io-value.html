<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../io-boolean/io-boolean.html">
<link rel="import" href="../io-input/io-input.html">
<link rel="import" href="../io-object/io-object.html">

<!--
`<io-value>` is a custom HTML element that can be used as input/output for variables of various data types such as boolean, string, number or object. The element will instantiate a type-specific value editor when value type changes.

Example:

    <io-value value="{{valueofanytype}}"></io-value>

This element is reliant on a set of type-specific such as `<io-boolean>`, `<io-iput>` and `<io-object>`. You can use these elements when you need an editor for a specific type.

Example:

    <io-boolean value="{{booleanvalue}}"></io-boolean>
    <io-input value="{{stringvalue}}"></io-input>
    <io-input type="float" value="{{numbervalue}}"></io-input>
    <io-object value="{{objectvalue}}"></io-object>

@demo demo/index.html Basic Demo
-->

<dom-module id="io-value">
  <style>
  :host {
    display: inline-block;
  }
  :host * {
    display: inline;
  }
  </style>
  <template></template>
</polymer-element>
<script>
  Polymer({
    is: 'io-value',
    properties: {
      /**
       * value
       */
      value: {
        notify: true,
        observer: '_valueChanged'
      },
      /**
       * immediate value (updated on each keystroke).
       */
      immediatevalue: {
        notify: true,
        // observer: '_immediatevalueChanged'
      },
      /**
       * If disabled, value cannot be changed by user action.
       */
      disabled: {
        notify: true,
        type: Boolean,
        // observer: '_disabledChanged'
      },
      /**
       * Type-specific editor instance.
       */
      _editor: {
        type: HTMLElement
      }
    },
    ready: function() {
      if (this.value === undefined) {
        this._valueChanged();
      }
    },
    _valueChanged: function() {
      this.immediatevalue = this.value;
      this._setEditorJob();
    },
    _immediatevalueChanged: function() {
      this._editor.immediatevalue = this.immediatevalue;
    },
    _disabledChanged: function() {
      this._editor.disabled = this.disabled;
    },
    _valueSet: function(event) {
      /**
       * This event is fired when value is set by user action.
       * This is a non-bubbling event.
       * @event io-value-set
       * @param {Object} detail value change data
       * @param {Object} detail.value new value
       * @param {Object} detail.oldValue old value
       */
      this.fire('io-value-set', {value: event.detail.value, oldValue: event.detail.oldValue}, {bubbles: false});
    },
    _setEditor: function() {

      var editor;
      if (typeof this.immediatevalue === 'string') {
        editor = 'io-input';
      } else if (this.immediatevalue === undefined) {
        editor = 'io-input';
      } else if (this.immediatevalue === null) {
        editor = 'io-input';
      } else if (this.immediatevalue === NaN) {
        editor = 'io-input';
      } else if (typeof this.immediatevalue === 'object') {
        editor = 'io-object';
      } else if (typeof this.immediatevalue === 'function') {
        editor = 'io-input';
      } else if (typeof this.immediatevalue === 'boolean') {
        editor = 'io-boolean';
      } else if (typeof this.immediatevalue === 'number') {
        editor = 'io-input';
      }

      // Set editor
      if (!this._editor || this._editor.localName !== editor) {

        this.innerHTML = '';

        this._editor = document.createElement(editor);
        this._editor.classList.toggle('io-value', true);
        if (typeof this.immediatevalue === 'number') {
          this._editor.type = 'float';
        }
        this.appendChild(this._editor);

        this._editor.addEventListener('value-changed', function(event) {
          this.value = event.detail.value;
        }.bind(this));
        this._editor.addEventListener('immediatevalue-changed', function(event) {
          this.immediatevalue = event.detail.value;
        }.bind(this));
        this._editor.addEventListener('io-value-set', this._valueSet.bind(this));
      };

      this._editor.value = this.value;
      this._editor.immediatevalue = this.immediatevalue;
      this._editor.disabled = this.disabled;

    },
    _setEditorJob: function() {
      this.debounce('io-value-set-editor', this._setEditor);
    }
  });
</script>
